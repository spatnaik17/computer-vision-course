# ResNet (æ®‹å·®ç½‘ç»œ)

äººä»¬ä¸€åº¦è®¤ä¸ºï¼Œå¢åŠ ç¥ç»ç½‘ç»œçš„å±‚æ•°èƒ½å¤Ÿæå‡æ¨¡å‹æ€§èƒ½ï¼Œå› æ­¤å±‚æ•°è¶Šå¤šçš„ç¥ç»ç½‘ç»œæ•ˆæœè¶Šå¥½ã€‚

éšç€ç½‘ç»œæ·±åº¦åŠ æ·±ï¼Œæ‰€æå–çš„ç‰¹å¾ä¹Ÿéšä¹‹æ›´åŠ ä¸°å¯Œï¼Œä¾‹å¦‚ VGG16 å’Œ VGG19 å°±è¯æ˜äº†è¿™ä¸€ç‚¹ã€‚

ç”±æ­¤äº§ç”Ÿäº†ä¸€ä¸ªé—®é¢˜ï¼šâ€œè®­ç»ƒæ·±åº¦å­¦ä¹ æ¨¡å‹æ˜¯å¦å°±åƒå †ç§¯æœ¨ä¸€æ ·ç®€å•ï¼Ÿâ€
ä¸ºäº†è§£ç­”è¿™ä¸ªé—®é¢˜ï¼Œé¦–å…ˆéœ€è¦è§£å†³æ¢¯åº¦æ¶ˆå¤±é—®é¢˜ï¼Œè€Œå½’ä¸€åŒ–åˆå§‹åŒ–å’Œä¸­é—´å½’ä¸€åŒ–å±‚ä¸ºæ­¤æä¾›äº†è§£å†³æ–¹æ¡ˆã€‚

ç„¶è€Œï¼Œæ–°çš„é—®é¢˜éšä¹‹å‡ºç°ï¼šé€€åŒ–é—®é¢˜ã€‚éšç€ç¥ç»ç½‘ç»œå˜å¾—æ›´æ·±ï¼Œæ¨¡å‹å‡†ç¡®ç‡è¾¾åˆ°é¥±å’Œï¼Œå¹¶è¿…é€Ÿä¸‹é™ã€‚ä¸€é¡¹é’ˆå¯¹æµ…å±‚å’Œæ·±å±‚æ™®é€šç½‘ç»œ(Plain Networks)çš„å¯¹æ¯”å®éªŒè¡¨æ˜ï¼Œæ›´æ·±çš„æ¨¡å‹è¡¨ç°å‡ºæ›´é«˜çš„è®­ç»ƒå’Œæµ‹è¯•è¯¯å·®ï¼Œè¿™è¡¨æ˜åœ¨æœ‰æ•ˆè®­ç»ƒæ›´æ·±å±‚æ¶æ„æ–¹é¢å­˜åœ¨æ ¹æœ¬æ€§çš„æŒ‘æˆ˜ã€‚è¿™ç§é€€åŒ–å¹¶éæºäºè¿‡æ‹Ÿåˆï¼Œè€Œæ˜¯å› ä¸ºå½“ç½‘ç»œåŠ æ·±æ—¶ï¼Œè®­ç»ƒè¯¯å·®åè€Œå¢åŠ ã€‚å¢åŠ çš„å±‚å¹¶æ²¡æœ‰é€¼è¿‘æ’ç­‰å‡½æ•°ã€‚

<img src="https://i.sstatic.net/xDLez.jpg" alt="Degradation-error" width="512" height="512">

ResNet é€šè¿‡æ®‹å·®è¿æ¥é‡Šæ”¾äº†æ·±åº¦ç½‘ç»œçš„æ½œåŠ›ï¼Œä¸ä¹‹å‰çš„æ¶æ„ç›¸æ¯”ï¼Œæ˜¾è‘—æé«˜äº†å‡†ç¡®ç‡ã€‚

## ResNet æ¶æ„

- ä¸€ä¸ªæ®‹å·®å—ã€‚æ¥æºï¼šResNet è®ºæ–‡
![residual](https://huggingface.co/datasets/hf-vision/course-assets/blob/main/ResnetBlock.png)

ResNet å¼•å…¥äº†æ®‹å·®å­¦ä¹ (Residual Learning)çš„æ¦‚å¿µï¼Œå®ƒå…è®¸ç½‘ç»œå­¦ä¹ æ®‹å·®ï¼ˆå³ï¼Œå­¦ä¹ åˆ°çš„è¡¨ç¤ºä¸è¾“å…¥ä¹‹é—´çš„å·®å¼‚ï¼‰ï¼Œè€Œä¸æ˜¯ç›´æ¥å­¦ä¹ è¾“å…¥åˆ°è¾“å‡ºçš„æ˜ å°„ã€‚è¿™æ˜¯é€šè¿‡è·³è·ƒè¿æ¥ï¼ˆskip connectionsï¼Œæˆ–ç§°æ·å¾„è¿æ¥(Shortcut Connections)ï¼‰å®ç°çš„ã€‚

ä¸‹é¢æˆ‘ä»¬æ¥è¯¦ç»†åˆ†æä¸€ä¸‹ï¼š

#### 1. åŸºæœ¬æ„å»ºå—ï¼šæ®‹å·®å—

åœ¨ä¸€ä¸ªå…¸å‹çš„ç¥ç»ç½‘ç»œå±‚ä¸­ï¼Œç›®æ ‡æ˜¯å­¦ä¹ ä¸€ä¸ªæ˜ å°„ F(x)ï¼Œå…¶ä¸­ x æ˜¯è¾“å…¥ï¼ŒF æ˜¯ç½‘ç»œåº”ç”¨çš„å˜æ¢ã€‚å¦‚æœæ²¡æœ‰æ®‹å·®å­¦ä¹ ï¼Œå±‚ä¸­çš„å˜æ¢ä¸ºï¼šy = F(x)ã€‚åœ¨ ResNet ä¸­ï¼Œç½‘ç»œå¹¶éç›´æ¥å­¦ä¹  F(x)ï¼Œè€Œæ˜¯è¢«è®¾è®¡ä¸ºå­¦ä¹ æ®‹å·® R(x)ï¼Œå…¶ä¸­ï¼šR(x) = F(x) âˆ’ xã€‚å› æ­¤ï¼Œæ®‹å·®å—ä¸­çš„å˜æ¢å¯ä»¥å†™æˆï¼šy = F(x) + xã€‚

è¿™é‡Œï¼Œx æ˜¯æ®‹å·®å—çš„è¾“å…¥ï¼ŒF(x) æ˜¯è¯¥å—å †å å±‚çš„è¾“å‡ºï¼ˆé€šå¸¸æ˜¯å·ç§¯ã€æ‰¹é‡å½’ä¸€åŒ–å’Œ ReLUï¼‰ã€‚æ’ç­‰æ˜ å°„ x ç›´æ¥åŠ åˆ° F(x) çš„è¾“å‡ºä¸Šï¼ˆé€šè¿‡è·³è·ƒè¿æ¥ï¼‰ã€‚å› æ­¤ï¼Œè¯¥å—å­¦ä¹ çš„æ˜¯æ®‹å·® R(x) = F(x)ï¼Œæœ€ç»ˆè¾“å‡ºæ˜¯ F(x) + xã€‚ä¸åŸå§‹æ˜ å°„ç›¸æ¯”ï¼Œè¿™ç§æ®‹å·®å‡½æ•°æ›´å®¹æ˜“ä¼˜åŒ–ã€‚å¦‚æœæœ€ä¼˜å˜æ¢æ¥è¿‘äºæ’ç­‰å˜æ¢ï¼ˆå³ï¼Œä¸éœ€è¦å˜æ¢ï¼‰ï¼Œç½‘ç»œå¯ä»¥å¾ˆå®¹æ˜“åœ°å°† F(x) è®¾ç½®ä¸ºæ¥è¿‘äº 0ï¼Œä»¥ä¾¿ç›´æ¥ä¼ é€’è¾“å…¥ã€‚

* ResNet çš„æ„å»ºå—å¦‚å›¾ç‰‡æ‰€ç¤ºï¼Œæ¥æº ResNet è®ºæ–‡ã€‚

![resnet_building_block](https://huggingface.co/datasets/hf-vision/course-assets/resolve/main/ResnetBlock.png)

#### 2. å­¦ä¹ æ®‹å·®ä¸æ¢¯åº¦æµ

ResNet åœ¨ææ·±ç½‘ç»œä¸­è¡¨ç°å‡ºè‰²çš„ä¸»è¦åŸå› æ˜¯åå‘ä¼ æ’­è¿‡ç¨‹ä¸­æ”¹è¿›çš„æ¢¯åº¦æµã€‚è®©æˆ‘ä»¬ä»æ•°å­¦è§’åº¦åˆ†æåå‘ä¼ æ’­è¿‡ç¨‹ã€‚å‡è®¾æœ‰ä¸€ä¸ªæ®‹å·®å— y = F(x) + xã€‚å½“é€šè¿‡é“¾å¼æ³•åˆ™è®¡ç®—æ¢¯åº¦æ—¶ï¼Œéœ€è¦è®¡ç®—æŸå¤± ğ¿ ç›¸å¯¹äºè¾“å…¥ x çš„å¯¼æ•°ã€‚å¯¹äºä¸€ä¸ªæ ‡å‡†å—ï¼ˆæ²¡æœ‰æ®‹å·®ï¼‰ï¼Œæ¢¯åº¦ä¸ºï¼š

`âˆ‚x/âˆ‚L = âˆ‚F(x)/âˆ‚L * âˆ‚F(x)/âˆ‚x`

ç„¶è€Œï¼Œå¯¹äºæ®‹å·®å—ï¼Œå…¶ä¸­ y = F(x) + xï¼Œæ¢¯åº¦å˜ä¸ºï¼š

`âˆ‚L/âˆ‚x = âˆ‚L/âˆ‚F(x) * âˆ‚F(x)/âˆ‚x + âˆ‚L/âˆ‚F(x) â‹…1`

è¯·æ³¨æ„ï¼Œç°åœ¨çš„æ¢¯åº¦è®¡ç®—ä¸­å¤šå‡ºäº†ä¸€é¡¹ 1ã€‚è¿™æ„å‘³ç€æ¯ä¸€å±‚çš„æ¢¯åº¦éƒ½æœ‰ä¸€æ¡ç›´æ¥è¿”å›åˆ°æ—©æœŸå±‚çš„è·¯å¾„ï¼Œä»è€Œæ”¹å–„äº†æ¢¯åº¦æµå¹¶å‡å°‘äº†æ¢¯åº¦æ¶ˆå¤±çš„å¯èƒ½æ€§ã€‚æ¢¯åº¦æ›´å®¹æ˜“åœ°é€šè¿‡ç½‘ç»œæµåŠ¨ï¼Œä»è€Œå…è®¸æ›´æ·±çš„ç½‘ç»œåœ¨æ²¡æœ‰é€€åŒ–çš„æƒ…å†µä¸‹è¿›è¡Œè®­ç»ƒã€‚

#### 3. ä¸ºä»€ä¹ˆç°åœ¨å¯ä»¥å®ç°æ›´æ·±çš„ç½‘ç»œï¼š

ResNet ä½¿å¾—è®­ç»ƒå…·æœ‰æ•°ç™¾ç”šè‡³æ•°åƒå±‚çš„ç½‘ç»œæˆä¸ºå¯èƒ½ã€‚ä»¥ä¸‹æ˜¯æ›´æ·±çš„ç½‘ç»œèƒ½å¤Ÿä»ä¸­å—ç›Šçš„åŸå› ï¼š

* æ’ç­‰æ·å¾„è¿æ¥(Identity Shortcut Connections)ï¼šæ·å¾„è¿æ¥æ‰§è¡Œæ’ç­‰æ˜ å°„ï¼Œå…¶è¾“å‡ºè¢«æ·»åŠ åˆ°å †å å±‚çš„è¾“å‡ºä¸­ã€‚æ’ç­‰æ·å¾„è¿æ¥æ—¢ä¸å¢åŠ é¢å¤–çš„å‚æ•°ï¼Œä¹Ÿä¸å¢åŠ è®¡ç®—å¤æ‚åº¦ã€‚è¿™äº›è¿æ¥ç»•è¿‡å±‚ï¼Œä¸ºä¿¡æ¯æµåˆ›å»ºç›´æ¥è·¯å¾„ï¼Œå¹¶ä¸”å®ƒä»¬ä½¿ç¥ç»ç½‘ç»œèƒ½å¤Ÿå­¦ä¹ æ®‹å·®å‡½æ•°(F)ã€‚
* æ›´å¥½çš„æ¢¯åº¦æµï¼šå¦‚å‰æ‰€è¿°ï¼Œæ®‹å·®æœ‰åŠ©äºæ¢¯åº¦åœ¨åå‘ä¼ æ’­æœŸé—´æ›´å¥½åœ°ä¼ æ’­ï¼Œä»è€Œè§£å†³äº†ææ·±ç½‘ç»œä¸­çš„æ¢¯åº¦æ¶ˆå¤±é—®é¢˜ã€‚
* æ›´æ˜“äºä¼˜åŒ–ï¼šé€šè¿‡å­¦ä¹ æ®‹å·®ï¼Œç½‘ç»œæœ¬è´¨ä¸Šæ˜¯å°†å­¦ä¹ è¿‡ç¨‹åˆ†è§£ä¸ºæ›´ç®€å•ã€å¢é‡çš„æ­¥éª¤ã€‚å¯¹äºç½‘ç»œè€Œè¨€ï¼Œå­¦ä¹ æ®‹å·® R(x) = F(x) âˆ’ x æ¯”ç›´æ¥å­¦ä¹  F(x) æ›´å®¹æ˜“ï¼Œå°¤å…¶æ˜¯åœ¨ææ·±çš„ç½‘ç»œä¸­ã€‚

### æ€»ç»“ï¼š

æˆ‘ä»¬å¯ä»¥å¾—å‡ºç»“è®ºï¼šResNet ç½‘ç»œ -> æ™®é€šç½‘ç»œ + æ·å¾„è¿æ¥ï¼

å¯¹äºè¿ç®—\(F(x) + x\)ï¼Œ\(F(x)\)å’Œ\(x\)åº”è¯¥å…·æœ‰ç›¸åŒçš„ç»´åº¦ã€‚
ResNet é‡‡ç”¨ä¸¤ç§æŠ€æœ¯æ¥å®ç°è¿™ä¸€ç‚¹ï¼š

- é›¶å¡«å……æ·å¾„(Zero-padding shortcuts)ï¼šå®ƒä½¿ç”¨é›¶å€¼å¡«å……é€šé“ï¼Œä¿æŒç»´åº¦ï¼Œä¸”ä¸ä¼šå¼•å…¥é¢å¤–çš„å¯å­¦ä¹ å‚æ•°ã€‚
- æŠ•å½±æ·å¾„(Projection shortcuts)ï¼šå®ƒåœ¨å¿…è¦æ—¶ä½¿ç”¨ 1x1 å·ç§¯æ¥è°ƒæ•´ç»´åº¦ï¼Œè¿™ä¼šæ¶‰åŠä¸€äº›é¢å¤–çš„å¯å­¦ä¹ å‚æ•°ã€‚

åœ¨æ›´æ·±çš„ ResNet æ¶æ„ä¸­ï¼Œå¦‚ ResNet 50ã€101 å’Œ 152ï¼Œé‡‡ç”¨äº†ä¸€ç§ä¸“é—¨çš„â€œç“¶é¢ˆæ„å»ºå—(Bottleneck building block)â€ï¼Œä»¥æ§åˆ¶å‚æ•°å¤æ‚æ€§ï¼Œå¹¶åœ¨å®ç°æ›´æ·±å±‚æ¬¡å­¦ä¹ çš„åŒæ—¶ä¿æŒæ•ˆç‡ã€‚

## ResNet ä»£ç 

### åœ¨ ImageNet ä¸Šé¢„è®­ç»ƒçš„æ·±åº¦æ®‹å·®ç½‘ç»œ

ä¸‹é¢å±•ç¤ºäº†å¦‚ä½•ä½¿ç”¨ transformers åº“åŠ è½½å¸¦æœ‰å›¾åƒåˆ†ç±»å¤´çš„é¢„è®­ç»ƒ ResNetã€‚
```python
from transformers import ResNetForImageClassification

model = ResNetForImageClassification.from_pretrained("microsoft/resnet-50")

model.eval()
```

æ‰€æœ‰é¢„è®­ç»ƒæ¨¡å‹éƒ½è¦æ±‚è¾“å…¥å›¾åƒä»¥ç±»ä¼¼çš„æ–¹å¼è¿›è¡Œå½’ä¸€åŒ–ï¼Œå³å½¢çŠ¶ä¸ºï¼ˆ3 x H x Wï¼‰çš„ 3 é€šé“ RGB å›¾åƒå°æ‰¹é‡ï¼Œå…¶ä¸­ H å’Œ W é¢„è®¡è‡³å°‘ä¸º 224ã€‚å›¾åƒå¿…é¡»åŠ è½½åˆ° [0, 1] èŒƒå›´å†…ï¼Œç„¶åä½¿ç”¨ mean = [0.485, 0.456, 0.406] å’Œ std = [0.229, 0.224, 0.225] è¿›è¡Œå½’ä¸€åŒ–ã€‚

è¿™æ˜¯ä¸€ä¸ªç¤ºä¾‹æ‰§è¡Œã€‚æ­¤ç¤ºä¾‹å¯åœ¨ [Hugging Face æ–‡æ¡£](https://huggingface.co/docs/transformers/v4.18.0/en/model_doc/resnet)ä¸­æ‰¾åˆ°ã€‚

```python
from transformers import AutoFeatureExtractor, ResNetForImageClassification
import torch
from datasets import load_dataset

dataset = load_dataset("huggingface/cats-image")
image = dataset["test"]["image"][0]

feature_extractor = AutoFeatureExtractor.from_pretrained("microsoft/resnet-50")
model = ResNetForImageClassification.from_pretrained("microsoft/resnet-50")

inputs = feature_extractor(image, return_tensors="pt")

with torch.no_grad():
    logits = model(**inputs).logits

# model predicts one of the 1000 ImageNet classes
predicted_label = logits.argmax(-1).item()
print(model.config.id2label[predicted_label])
```

## å‚è€ƒæ–‡çŒ®

- [PyTorch docs](https://pytorch.org/hub/pytorch_vision_resnet/)
- [ResNet: Deep Residual Learning for Image Recognition](https://arxiv.org/abs/1512.03385)

- [Resnet Architecture Source: ResNet Paper](https://arxiv.org/abs/1512.03385)
- [Hugging Face Documentation on ResNet](https://huggingface.co/docs/transformers/en/model_doc/resnet)

